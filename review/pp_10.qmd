---
title: "Chapter 10 Practice Problems"
author: "David Gerard"
date: today
---

These practice problems mostly come from Rosner's publicly available study sheet at the books [companion website](https://www.cengage.com/cgi-wadsworth/course_products_wp.pl?fid=M20b&product_isbn_issn=9781305268920). The solutions are my own, since we differ slightly on what we are looking for in the solutions.

```{r}
#| echo: false
#| eval: true
#| message: false
library(tidyverse)
library(gt)
library(broom)
plt_t <- function(
    mu = 0, 
    sig = 1, 
    lb = -Inf,
    ub = Inf,
    df = Inf, 
    rng = c(-3, 3), 
    two_sided = FALSE,
    col = "#E69F00",
    lwd = 1) {
  tibble(x = seq(mu + rng[[1]] * sig, mu + rng[[2]] * sig, length.out = 500)) |>
    mutate(y = dt(x = (x - mu) / sig, df = df)) ->
    df1
  df1 |>
    filter(x > lb, x < ub) ->
    df2
  ggplot() +
    geom_line(data = df1, mapping = aes(x = x, y = y), linewidth = lwd) +
    geom_area(data = df2, mapping = aes(x = x, y = y), fill = col) +
    geom_line(data = df2, mapping = aes(x = x, y = y), color = col, linewidth = lwd) +
    theme_classic() +
    theme(axis.title = element_blank()) ->
    pl
  
  if (two_sided) {
    df1 |>
      filter(x > -ub, x < -lb) ->
      df3
    pl <- pl + 
      geom_area(data = df3, mapping = aes(x = x, y = y), fill = col) +
      geom_line(data = df3, mapping = aes(x = x, y = y), color = col, linewidth = lwd)
  }
  pl
}
plt_chisq <- function(
    df,
    lb,
    rng = c(0, lb + 1)) {
  tibble(x = seq(rng[[1]], rng[[2]], length.out = 500)) |>
    mutate(y = stats::dchisq(x = x, df = df)) ->
    dat
  
  dat |>
    filter(x >= lb) ->
    dat_sub
  
  ggplot() +
    geom_line(data = dat, mapping = aes(x = x, y = y)) +
    geom_area(data = dat_sub, mapping = aes(x = x, y = y), fill = "#E69F00", color = "#E69F00") +
    theme_classic() +
    geom_vline(xintercept = lb, lty = 2, col = "red") +
    xlab(expression(x^2)) +
    ylab("Density")
}
plt_binom <- function(
    size, 
    prob = 0.5, 
    lb = -Inf,
    ub = Inf, 
    rng = c(0, size),
    col = "#E69F00",
    valmax = NULL,
    lwd = 1) {
  
  tibble(x = seq(rng[[1]], rng[[2]], by = 1)) |>
    mutate(
      pmf = stats::dbinom(x = x, size = size, prob = prob)
      ) ->
    df
  
  if (is.null(valmax)) {
    df |>
      mutate(col = (x >= lb & x <= ub)) ->
      df
  } else {
    df |>
      mutate(col = pmf <= stats::dbinom(x = valmax, size = size, prob = prob)) ->
      df
  }
  df |>
    ggplot(aes(x = x, xend = x, yend = pmf, color = col)) +
    geom_segment(y = 0, lwd = lwd) +
    theme_classic() +
    theme(axis.title = element_blank()) +
    scale_color_manual(values = c("black", col), guide = "none") +
    scale_x_continuous(breaks = seq(rng[[1]], rng[[2]]))
}
#' @param tab a table with dimnames as a list with column names and row names and each dimension is named
#' 
#' @examples
#' tab <- matrix(c(1, 2, 3, 4), nrow = 2, byrow = TRUE)
#' dimnames(tab) <- list(A = c("B", "C"), D = c("E", "F"))
#' cont_tab(tab)
cont_tab <- function(tab) {
  tib <- as_tibble(tab, rownames = names(dimnames(tab))[[1]]) 
  tib$Total <- rowSums(tib[-1])
  tib <- rbind(tib, NA)
  tib[[1]][[nrow(tib)]] <- "Total"
  for (i in 2:ncol(tib)) {
    tib[[i]][[nrow(tib)]] <- sum(tib[[i]], na.rm = TRUE)
  }
  
  gt(tib) |>
    tab_spanner(
      label = names(dimnames(tab))[[2]],
      columns = names(tib)[-c(1, ncol(tib))]
    ) |>
    tab_style(
      style = cell_borders(sides = "left", style = "double"),
      locations = cells_body(columns = c(2, ncol(tib)))
    ) |>
    tab_style(
      style = cell_borders(sides = "top", style = "double"),
      locations = cells_body(rows = c(1, nrow(tib)))
    )
}
```


## Cardiovascular Disease 1
In a 1985 study of the effectiveness of streptokinase in the treatment of patients who have been hospitalized after myocardial infarction, 9 of 199 males receiving streptokinase and 13 of 97 males in the control group died within 12 months.

::: {.panel-tabset}
## 10.1 
Use the normal-theory method to test for significant differences in 12-month mortality between the two groups.

## Solution
Let $X_1$ be the number of deaths out of the $n_1 = 199$ males receiving strptokinase. Let $X_2$ be the number of deaths out of the $n_2 = 97$ control males. Then $X_1 \sim \mathrm{Binom}(199, p_1)$ and $X_2 \sim \mathrm{Binom}(97, p_2)$. We are testing $H_0: p_1 = p_2$ versus $H_A: p_1 \neq p_2$. We calculate statistics

- $\hat{p}_1 = 9/199 = 0.04523$
- $\hat{p}_2 = 13/97 = 0.134$
- $\hat{p} = (9 + 13) / (97 + 199) = 0.07432$

Using the normal theory, we calculate the test statistic
$$
Z = \frac{\hat{p}_1 - \hat{p}_2}{\sqrt{\left(\frac{1}{n_1} + \frac{1}{n_2}\right)\hat{p}(1-\hat{p})}} = \frac{0.04535 - 0.134}{\left(\frac{1}{199} + \frac{1}{97}\right)\times0.07432\times(1-0.07432)}
$$
Numerically,
```{r}
(0.04535 - 0.134) / sqrt((1/199 + 1/97) * 0.07432 * (1 - 0.07432))
```

We compare this to the null distribution of $N(0,1)$
```{r}
#| echo: false
plt_t(ub = -2.729, two_sided = TRUE, rng = c(-4, 4))+
  geom_vline(xintercept = -2.729, lty = 2, col = 2)
```
```{r}
2 * pnorm(-2.729)
```
So there is a significant difference of death rates between the two groups.

You can use `prop.test()` to do this. It will give you slightly different (better) results because it will do a continutity correction.
```{r}
prop.test(x = c(9, 13), n = c(199, 97)) |>
  tidy() |>
  select(p.value)
```
:::

::: {.panel-tabset}
## 10.2 
Construct the observed and expected contingency tables for these data.

## Solution

Observed
```{r}
#| echo: false
matrix(c(9, 199 - 9, 13, 97 - 13), nrow = 2, byrow = TRUE,
       dimnames = list(streptokinase = c("Yes", "No"), died = c("Yes", "No"))) |>
  cont_tab()
```
Expected:
```{r}
#| echo: false
matrix(c(199 * 22 / 296, 199 * 274 / 296, 97 * 22 / 296, 97 * 274 / 296), nrow = 2, byrow = TRUE,
       dimnames = list(streptokinase = c("Yes", "No"), died = c("Yes", "No"))) |>
  cont_tab()
```
:::


::: {.panel-tabset}
## 10.3 
Perform the test in Problem 10.1 using the contingency-table method.

## Solution
We calculate $\sum_{\text{categories}} \frac{(o-e)^2}{e}
$$
\frac{(9 - 14.791)^2}{14.791} + \frac{(190 - 184.21)^2}{184.21} + \frac{(13 - 7.209)^2}{7.209} + \frac{(84 - 89.79)^2}{89.79}
$$
Numerically
```{r}
(9 - 14.791)^2 / 14.791 + (190 - 184.21)^2 / 184.21 + (13 - 7.209)^2 / 7.209 + (84 - 89.79)^2 / 89.79
```
Under the null, this follows a chi-squared distribution with 1 degree of freedom ($\chi^2_1$). We get the $p$-value by the area under the curve above 7.475
```{r}
#| echo: false
plt_chisq(df = 1, lb = 7.45)
```
```{r}
1 - pchisq(q = 7.475, df = 1)
```
So we have strong evidence of an association between streptokinase use and death.

The real-way in R is to use `chisq.test()`
```{r}
matrix(c(9, 190, 13, 84), nrow = 2, ncol = 2, byrow = TRUE) |>
  chisq.test() |>
  tidy()
```
The $p$-value again differs because before we did not do a continuity correction.
:::


::: {.panel-tabset}
## 10.4 
Compare your results in Problems 10.1 and 10.3.

## Solution
The $p$-values are the exact same. Theoretically, this should be the case.

:::

## Cardiovascular Disease 2
In the streptokinase study in Problem 10.1, 2 of 15 females receiving streptokinase and 4 of 19 females in the control group died within 12 months.

::: {.panel-tabset}
## 10.5 
Why is Fisher’s exact test the appropriate procedure to test for differences in 12-month mortality rates between these two groups?

## Solution
The sample size is too low for asymptotic approximation to work well. Our rule of thumb is that we need an expected count of at least five in each cell. Our observed table is
```{r}
#| echo: false
matrix(c(2, 15 - 2, 4, 19 - 4), nrow = 2, byrow = TRUE,
       dimnames = list(streptokinase = c("Yes", "No"), died = c("Yes", "No"))) |>
  cont_tab()
```
These are small, but we base our decision to do an exact test based on the **expected** counts, which are:
```{r}
#| echo: false
matrix(c(6 * 15 / 34, 28 * 15 / 34, 6 * 19 / 34, 28 * 19 / 34), nrow = 2, byrow = TRUE,
       dimnames = list(streptokinase = c("Yes", "No"), died = c("Yes", "No"))) |>
  cont_tab()
```
There are two cells here with expected counts under 5, so we cannot use an asymptotic approach.

:::

::: {.panel-tabset}
## 10.6 
Write down all possible tables with the same row and column margins as given in the observed data.

## Solution
$$
\begin{pmatrix}
0 & 15\\
6 & 13
\end{pmatrix},
\begin{pmatrix}
1 & 14\\
5 & 14
\end{pmatrix},
\begin{pmatrix}
2 & 13\\
4 & 15
\end{pmatrix},
\begin{pmatrix}
3 & 12\\
3 & 16
\end{pmatrix},
\begin{pmatrix}
4 & 11\\
2 & 17
\end{pmatrix},
\begin{pmatrix}
5 & 10\\
1 & 18
\end{pmatrix},
\begin{pmatrix}
6 & 9\\
0 & 19
\end{pmatrix}
$$
:::

::: {.panel-tabset}
## 10.8
The conditional null probabilities for tables in question 10.6 are:

```{r}
#| echo: false
## 38 total balls
## Draw 28 of them
## 19 are white and 15 are black
## How many white
dhyper(x = 13:19, m = 19, n = 15, k = 28)
```
Our observed table is the third one (with probability 0.302609)

Evaluate whether or not there is a significant difference between the mortality rates for streptokinase and control-group females using a two-sided test.

## Solution
The $p$-value is
```{r}
0.020174 + 0.129690 + 0.302609 + 0.173555 + 0.042425 + 0.003721
```
So we do not have a significance difference between the mortaility rates for the two groups.

We can verify our calculation in R
```{r}
matrix(c(2, 13, 4, 15), nrow = 2, ncol = 2, byrow = TRUE) |>
  fisher.test() |>
  tidy()
```
:::

## Cardiovascular Disease 3
A 1979 study investigated the relationship between cigarette smoking and subsequent mortality in men with a prior history of coronary disease. It was found that 264 out of 1731 non-smokers and 208 out of 1058 smokers had died in the 5-year period after the study began.

::: {.panel-tabset}
## 10.12 
Assuming that the age distributions of the two groups are comparable, compare the mortality rates in the two groups.

## Solution
We have this observed table of counts:
```{r}
#| echo: false
matrix(c(264, 1731 - 264, 208, 1058 - 208), nrow = 2, ncol = 2, byrow = TRUE,
       dimnames = list(smoker = c("No", "Yes"), died = c("Yes", "No"))) |>
  cont_tab()
```

Expected counts:
```{r}
#| echo: false
matrix(c(472 * 1731 / 2789, 2317 * 1731 / 2789, 472 * 1058 / 2789, 2317 * 1058 / 2789),
       nrow = 2, ncol = 2, byrow = TRUE,
       dimnames = list(smoker = c("No", "Yes"), died = c("Yes", "No"))) |>
  cont_tab()
```

We calculate the test-statistic
$$
\frac{(264 - 292.9)^2}{292.9} + \frac{(1467 - 1438.1)^2}{1438.1} + \frac{(208 - 179.1)^2}{179.1} + \frac{(850 - 878.9)^2}{878.9}
$$
Numerically
```{r}
(264 - 292.9)^2 / 292.9 + (1467 - 1438.1)^2 / 1438.1 + (208 - 179.1)^2 / 179.1 + (850 - 878.9)^2 / 878.9
```
We compare this to a chi-squared distribution with one degree of freedom
```{r}
#| echo: false
plt_chisq(df = 1, lb = 9.046)
```
```{r}
1 - pchisq(q = 9.046, df = 1)
```
So we have strong evidence that there is an association between smoking status and death.

The real-way in R is
```{r}
matrix(c(264, 1467, 208, 850), nrow = 2, ncol = 2, byrow = TRUE) |>
  chisq.test() |>
  tidy()
```
The p-values differ because of the continuity correction.
:::

## Obstetrics 1
Suppose there are 500 pairs of pregnant women who participate in a prematurity study and are paired in such a way that the body weights of the 2 women in a pair are within 5 lb of each other. One of the 2 women is given a placebo and the other drug A to see if drug A has an effect in preventing prematurity. Suppose that in 30 pairs of women, both women in a pair have a premature child; in 420 pairs of women, both women have a normal child; in 35 pairs of women, the woman taking drug A has a normal child and the woman taking the placebo has a premature child; in 15 pairs of women, the woman taking drug A has a premature child and the woman taking the placebo has a normal child.

::: {.panel-tabset}
## 10.13 
Assess the statistical significance of these results.

## Solution
We wish to test the null hypothesis that the probability of a premature child is the same in both the drug and the control groups, against the alternative that they differ. This is a matched pairs design, so we should be thinking about McNemar's test. Let's build a paired contingency table.
```{r}
#| echo: false
matrix(c(420, 35, 15, 500 - 420 - 35 - 15), nrow = 2, ncol = 2, byrow = FALSE,
       dimnames = list(control = c("Normal", "Premature"), drug = c("Normal", "Premature"))) |>
  cont_tab()
```
Let $X$ be the number of pairs where the drug woman has a premature baby and the control woman has a normal baby. Then $X \sim \mathrm{Binom}(50, p)$. We are testing the null $H_0: p = 1/2$ versus $H_A: p \neq 1/2$. Since $n \geq 20$, we can use the normal-based approach. We could also use an exact approach. Let's calculate the test statistic
$$
Z = \frac{\hat{p} - p_0}{\sqrt{p_0(1-p_0)/n}} = \frac{15/50 - 1/2}{\sqrt{1/2(1 - 1/2)/50}}
$$
Numerically (also doing a continuity correction)
```{r}
(15/50 - 0.5 + 1/(2 * 50)) / sqrt(0.5 * (1 - 0.5) / 50)
```
We compare this to a standard normal distribution
```{r}
plt_t(ub = -2.687, two_sided = TRUE, rng = c(-4, 4)) +
  geom_vline(xintercept = -2.687, lty = 2, col = 2)
```
```{r}
2 * pnorm(-2.687)
```

This fits the "real-way" using `prop.test()`
```{r}
prop.test(x = 15, n = 50, p = 1/2) |>
  tidy() |>
  select(p.value, conf.low, conf.high)
```
Either way, we have strong evidence that the premature rate differs between drug and control groups. Indeed, our confidence interval indicates that the drug reduces the premature rate.
:::

## Obstetrics 2
An issue of current interest is the effect of delayed childbearing on pregnancy outcome. In a recent paper a population of first deliveries was assessed for low-birthweight deliveries (<2500 g) according to the woman’s age and prior pregnancy history. The data in Table 10.3 were presented.

```{r}
#| echo: false
tibble(
  Age = c("≥30", "≥30", "<30", "<30"),
  History = c("No", "Yes", "No", "Yes"),
  n = c(225, 88, 906, 503), 
  `Percentage Low Birthweight` = c(3.56, 6.82, 3.31, 1.31)) |>
  gt() |>
  tab_header(
    title = "Table 10.3",
    subtitle = "Relationship of age and pregnancy history to low-birthweight deliveries"
  ) |>
  tab_footnote(
    footnote = md("History = Yes if a woman had a prior history of spontaneous abortion or infertility, = no otherwise"),
    locations = cells_column_labels(columns = History)
  )
```

::: {.panel-tabset}
## 10.35 
What test can be used to assess the effect of age on low-birthweight deliveries among women with a negative history?

## Solution
Let's convert this into a 2x2 table. There are 225 women age ≥30 with a negative histroy. Among those, 225 * 0.0356 = 8 have a low birthweight. There are 906 women <30 with a negative history, among those 906 * 0.0331 = 30 have a low birthweight. 
```{r}
#| echo: false
matrix(c(8, 225 - 8, 30, 906 - 30), nrow = 2, ncol = 2, byrow = TRUE,
       dimnames = list(Age = c("≥30", "<30"), `Low Birthweight` = c("Yes", "No"))) |>
  cont_tab()
```

We can do a chi-squared test to test the null that age is independent of low birthweight status, against the alternative that they are dependent.


:::

::: {.panel-tabset}
## 10.36 
Perform the test in Problem 10.35 and report a p-value.

## Solution
You should be able to do this by hand now. Calculate the expected counts
```{r}
#| echo: false
matrix(c(28 * 225, 1093 * 225, 38 * 906, 1093 * 906) / 1131, nrow = 2, ncol = 2, byrow = TRUE,
       dimnames = list(Age = c("≥30", "<30"), `Low Birthweight` = c("Yes", "No"))) |>
  cont_tab()
```
Then calculate the chi-squared statistic, which ends up being about 0.033. The $p$-value then is calculated from a $\chi^2_1$ distribution
```{r}
#| echo: false
plt_chisq(df = 1, lb = 0.033)
```
```{r}
1 - pchisq(q = 0.033, df = 1)
```
So we have no evidence of an association between age of first birth and low birthweight status among women without a history.

```{r}
#| echo: false
#| eval: false
matrix(c(8, 217, 30, 876), nrow = 2, byrow = TRUE) |>
  chisq.test(correct = FALSE) |>
  tidy()
```

:::
